<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attack Chain - Real-time Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .result-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        .log-entry {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen">
    <!-- Navigation -->
    <nav class="bg-slate-800 border-b border-blue-500/20 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                BreachPilot - Real-time Attack Chain
            </h1>
            <a href="/" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700">Home</a>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        <!-- Attack Form -->
        <div class="result-card rounded-xl p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Start Penetration Test</h2>
            <div class="flex gap-4">
                <input 
                    type="text" 
                    id="target-input" 
                    placeholder="Enter target domain or IP" 
                    class="flex-1 px-4 py-2 bg-slate-800 border border-blue-500/30 rounded-lg focus:border-blue-400 focus:outline-none"
                >
                <button 
                    onclick="startAttack()" 
                    class="px-6 py-2 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700">
                    Start Attack
                </button>
            </div>
        </div>

        <!-- Progress -->
        <div id="progress-section" class="result-card rounded-xl p-6 mb-6" style="display: none;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Progress</h2>
                <span id="progress-text" class="text-blue-400">0%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3">
                <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all" style="width: 0%"></div>
            </div>
            <p id="current-task" class="text-gray-400 mt-2">Initializing...</p>
        </div>

        <!-- Real-time Logs -->
        <div id="logs-section" class="result-card rounded-xl p-6 mb-6" style="display: none;">
            <h2 class="text-xl font-bold mb-4">Real-time Logs</h2>
            <div id="logs-container" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- Logs will appear here -->
            </div>
        </div>

        <!-- OSINT Results -->
        <div id="osint-section" class="result-card rounded-xl p-6 mb-6" style="display: none;">
            <h2 class="text-xl font-bold mb-4">üîç OSINT Intelligence</h2>
            <div id="osint-content" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- OSINT results will appear here -->
            </div>
        </div>

        <!-- Nmap Results -->
        <div id="nmap-section" class="result-card rounded-xl p-6 mb-6" style="display: none;">
            <h2 class="text-xl font-bold mb-4">üîé Port Scan Results</h2>
            <div id="nmap-content">
                <!-- Nmap results will appear here -->
            </div>
        </div>

        <!-- Vulnerability Results -->
        <div id="vuln-section" class="result-card rounded-xl p-6 mb-6" style="display: none;">
            <h2 class="text-xl font-bold mb-4">‚ö†Ô∏è Vulnerabilities Found</h2>
            <div id="vuln-content">
                <!-- Vulnerability results will appear here -->
            </div>
        </div>
    </div>

    <script>
        let chainId = null;
        let statusInterval = null;

        async function startAttack() {
            const target = document.getElementById('target-input').value.trim();
            if (!target) {
                alert('Please enter a target');
                return;
            }

            try {
                // Create attack chain
                const createResponse = await fetch('/api/attack-chain/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ target: target })
                });
                
                const createData = await createResponse.json();
                if (!createData.success) {
                    alert('Failed to create attack chain: ' + createData.error);
                    return;
                }
                
                chainId = createData.chain_id;
                
                // Show progress sections
                document.getElementById('progress-section').style.display = 'block';
                document.getElementById('logs-section').style.display = 'block';
                
                // Execute attack chain
                const executeResponse = await fetch(`/api/attack-chain/${chainId}/execute`, {
                    method: 'POST'
                });
                
                // Start status polling
                statusInterval = setInterval(updateStatus, 2000);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error starting attack: ' + error.message);
            }
        }

        async function updateStatus() {
            if (!chainId) return;

            try {
                const response = await fetch(`/api/attack-chain/${chainId}/status`);
                const data = await response.json();
                
                // Update progress
                const progress = data.progress || 0;
                document.getElementById('progress-bar').style.width = progress + '%';
                document.getElementById('progress-text').textContent = Math.round(progress) + '%';
                document.getElementById('current-task').textContent = data.current_task || 'Waiting...';
                
                // Update logs
                if (data.logs && data.logs.length > 0) {
                    updateLogs(data.logs);
                }
                
                // Update results
                if (data.results) {
                    if (data.results.osint && Object.keys(data.results.osint).length > 0) {
                        displayOSINTResults(data.results.osint);
                    }
                    if (data.results.nmap && Object.keys(data.results.nmap).length > 0) {
                        displayNmapResults(data.results.nmap);
                    }
                    if (data.results.vulnerabilities && Object.keys(data.results.vulnerabilities).length > 0) {
                        displayVulnResults(data.results.vulnerabilities);
                    }
                }
                
                // Stop polling if completed
                if (data.status === 'completed' || data.status === 'failed') {
                    clearInterval(statusInterval);
                    if (data.status === 'completed') {
                        document.getElementById('current-task').textContent = '‚úÖ Attack chain completed!';
                    } else {
                        document.getElementById('current-task').textContent = '‚ùå Attack chain failed';
                    }
                }
                
            } catch (error) {
                console.error('Status update error:', error);
            }
        }

        function updateLogs(logs) {
            const container = document.getElementById('logs-container');
            
            logs.forEach(log => {
                const logId = `log-${log.timestamp}`;
                if (!document.getElementById(logId)) {
                    const logEntry = document.createElement('div');
                    logEntry.id = logId;
                    logEntry.className = 'log-entry p-3 rounded bg-slate-800/50';
                    
                    const levelColor = {
                        'error': 'text-red-400',
                        'warning': 'text-yellow-400',
                        'success': 'text-green-400',
                        'info': 'text-blue-400'
                    }[log.level] || 'text-gray-400';
                    
                    logEntry.innerHTML = `
                        <span class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleTimeString()}</span>
                        <span class="${levelColor} ml-2">${log.message}</span>
                    `;
                    
                    container.appendChild(logEntry);
                    container.scrollTop = container.scrollHeight;
                }
            });
        }

        function displayOSINTResults(osint) {
            document.getElementById('osint-section').style.display = 'block';
            const content = document.getElementById('osint-content');
            
            content.innerHTML = `
                <div class="bg-slate-800/50 p-4 rounded">
                    <h3 class="font-semibold text-blue-400 mb-2">DNS Records</h3>
                    <div class="text-sm space-y-1">
                        ${Object.entries(osint.dns_records || {}).map(([type, records]) => 
                            records.length > 0 ? `<div><span class="text-gray-400">${type}:</span> ${records.join(', ')}</div>` : ''
                        ).join('')}
                    </div>
                </div>
                
                <div class="bg-slate-800/50 p-4 rounded">
                    <h3 class="font-semibold text-purple-400 mb-2">Subdomains</h3>
                    <div class="text-sm">
                        ${osint.subdomains && osint.subdomains.length > 0 ? 
                            `Found ${osint.subdomains.length} subdomains` : 
                            'No subdomains found'}
                    </div>
                </div>
                
                <div class="bg-slate-800/50 p-4 rounded">
                    <h3 class="font-semibold text-green-400 mb-2">SSL Certificate</h3>
                    <div class="text-sm space-y-1">
                        ${osint.ssl_info && !osint.ssl_info.error ? `
                            <div>Issuer: ${osint.ssl_info.issuer?.organizationName || 'Unknown'}</div>
                            <div>Valid: ${osint.ssl_info.not_before} - ${osint.ssl_info.not_after}</div>
                        ` : '<div class="text-gray-400">No SSL info available</div>'}
                    </div>
                </div>
                
                <div class="bg-slate-800/50 p-4 rounded">
                    <h3 class="font-semibold text-yellow-400 mb-2">IP Addresses</h3>
                    <div class="text-sm">
                        ${osint.ip_addresses && osint.ip_addresses.length > 0 ? 
                            osint.ip_addresses.join(', ') : 
                            'No IPs resolved'}
                    </div>
                </div>
            `;
        }

        function displayNmapResults(nmap) {
            document.getElementById('nmap-section').style.display = 'block';
            const content = document.getElementById('nmap-content');
            
            const ports = nmap.ports || [];
            
            content.innerHTML = `
                <div class="mb-4">
                    <span class="text-blue-400 font-semibold">${ports.length} open ports found</span>
                </div>
                <div class="space-y-2">
                    ${ports.map(port => `
                        <div class="bg-slate-800/50 p-3 rounded flex justify-between items-center">
                            <div>
                                <span class="text-green-400 font-mono">${port.port}/${port.protocol}</span>
                                <span class="text-gray-400 ml-4">${port.service}</span>
                            </div>
                            <span class="text-sm text-gray-500">${port.version || ''}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function displayVulnResults(vulns) {
            document.getElementById('vuln-section').style.display = 'block';
            const content = document.getElementById('vuln-content');
            
            const vulnerabilities = vulns.vulnerabilities || [];
            
            if (vulnerabilities.length === 0) {
                content.innerHTML = '<div class="text-gray-400">No vulnerabilities identified</div>';
                return;
            }
            
            content.innerHTML = `
                <div class="mb-4">
                    <span class="text-red-400 font-semibold">${vulnerabilities.length} potential vulnerabilities found</span>
                    <span class="ml-4 text-gray-400">Risk Score: ${vulns.risk_score || 0}</span>
                </div>
                <div class="space-y-3">
                    ${vulnerabilities.map(vuln => `
                        <div class="bg-slate-800/50 p-4 rounded border-l-4 ${
                            vuln.severity === 'CRITICAL' ? 'border-red-500' :
                            vuln.severity === 'HIGH' ? 'border-orange-500' :
                            vuln.severity === 'MEDIUM' ? 'border-yellow-500' :
                            'border-blue-500'
                        }">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-semibold">${vuln.cve}</span>
                                <span class="px-2 py-1 rounded text-xs ${
                                    vuln.severity === 'CRITICAL' ? 'bg-red-500/20 text-red-400' :
                                    vuln.severity === 'HIGH' ? 'bg-orange-500/20 text-orange-400' :
                                    vuln.severity === 'MEDIUM' ? 'bg-yellow-500/20 text-yellow-400' :
                                    'bg-blue-500/20 text-blue-400'
                                }">${vuln.severity}</span>
                            </div>
                            <div class="text-sm text-gray-400">${vuln.description}</div>
                            <div class="text-xs text-gray-500 mt-2">CVSS: ${vuln.cvss_score} | Port: ${vuln.port || 'N/A'}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
    </script>
</body>
</html>