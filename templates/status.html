{% extends 'base.html' %}
{% block title %}Status - BreachPilot{% endblock %}
{% block content %}

<section class="glass card rounded-xl p-6">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-xl font-semibold">AI-Assisted Penetration Test</h2>
    <div class="flex items-center gap-2">
      <div id="status-indicator" class="h-3 w-3 rounded-full bg-yellow-400 animate-pulse"></div>
      <span id="status-text" class="text-sm font-medium">{{ status|title }}</span>
    </div>
  </div>
  
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div class="bg-slate-800/30 rounded-lg p-4">
      <p class="text-sm text-gray-400 mb-1">Job ID</p>
      <p class="font-mono text-sm">{{ job_id }}</p>
    </div>
    <div class="bg-slate-800/30 rounded-lg p-4">
      <p class="text-sm text-gray-400 mb-1">Target</p>
      <p class="font-mono text-sm">{{ job.target if job else 'Unknown' }}</p>
    </div>
  </div>

  <!-- Enhanced Progress Bar -->
  <div class="mb-6">
    <div class="flex justify-between items-center mb-2">
      <h3 class="text-sm font-semibold">Progress</h3>
      <span id="progress-percent" class="text-sm text-gray-400">{{ progress if progress else 0 }}%</span>
    </div>
    <div class="w-full bg-slate-800 rounded-full h-2">
      <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-purple-500 h-2 rounded-full transition-all duration-500" 
           style="width: {{ progress if progress else 0 }}%"></div>
    </div>
  </div>

  <!-- Enhanced Phase Timeline -->
  <div class="mb-8">
    <h3 class="text-sm font-semibold mb-4">AI Agent Pipeline</h3>
    <div class="space-y-3">
      {% set phases = [
        ('scan', 'Network Scan', 'Nmap + service enumeration'),
        ('ai_scan_analysis', 'AI Scan Analysis', 'CrewAI vulnerability assessment'),
        ('poc', 'PoC Research', 'GitHub/ExploitDB search'),
        ('ai_poc_research', 'AI PoC Analysis', 'CrewAI exploit evaluation'),
        ('exploit', 'Exploit Execution', 'Controlled PoC testing'),
        ('ai_exploit_analysis', 'AI Result Analysis', 'CrewAI impact assessment'),
        ('report', 'Report Generation', 'Claude-powered comprehensive report')
      ] %}
      
      {% for phase_id, phase_name, phase_desc in phases %}
        {% set is_current = job and job.phase == phase_id %}
        {% set is_completed = job and (job.status == 'completed' or (phases|map('first')|list).index(phase_id) < (phases|map('first')|list).index(job.phase|default('scan'))) %}
        
        <div class="flex items-center gap-4 p-3 rounded-lg {{ 'bg-indigo-900/30 border border-indigo-400/20' if is_current else 'bg-slate-800/20' if is_completed else 'bg-slate-800/10' }}">
          <div class="flex items-center justify-center h-8 w-8 rounded-full {{ 'bg-indigo-500 text-white' if is_current else 'bg-green-500 text-white' if is_completed else 'bg-slate-600 text-gray-300' }}">
            {% if is_completed %}
              <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
            {% elif is_current %}
              <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
              </svg>
            {% else %}
              <span class="text-xs">{{ loop.index }}</span>
            {% endif %}
          </div>
          <div class="flex-1">
            <h4 class="text-sm font-medium {{ 'text-white' if is_current else 'text-gray-300' }}">{{ phase_name }}</h4>
            <p class="text-xs {{ 'text-indigo-200' if is_current else 'text-gray-400' }}">{{ phase_desc }}</p>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Results Section -->
  {% if job and job.status == 'completed' %}
    <div class="bg-green-900/30 border border-green-400/20 rounded-lg p-4 mb-6">
      <div class="flex items-center gap-2 mb-3">
        <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
        </svg>
        <h3 class="text-sm font-semibold text-green-300">Test Completed Successfully</h3>
      </div>
      <p class="text-sm text-green-200 mb-4">AI analysis and comprehensive report generation completed.</p>
      <div class="space-x-3">
        <a href="/results/{{ job_id }}" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition">View Results</a>
        <a href="/download/{{ job_id }}/md" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition">Download Markdown</a>
        <a href="/download/{{ job_id }}/pdf" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition">Download PDF</a>
      </div>
    </div>
  {% elif job and job.status == 'failed' %}
    <div class="bg-red-900/30 border border-red-400/20 rounded-lg p-4 mb-6">
      <div class="flex items-center gap-2 mb-3">
        <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
        </svg>
        <h3 class="text-sm font-semibold text-red-300">Test Failed</h3>
      </div>
      <pre class="bg-red-900/40 border border-red-400/20 p-3 rounded text-red-200 text-xs overflow-auto">{{ job.error }}</pre>
    </div>
  {% endif %}

  <!-- Live Scan Results -->
  {% if job and job.scan %}
    <div class="bg-slate-800/30 rounded-lg p-4 mb-6">
      <h3 class="text-sm font-semibold mb-3">Network Scan Results</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <p class="text-xs text-gray-400 mb-1">Target</p>
          <p class="font-mono text-sm">{{ job.scan.target }}</p>
        </div>
        <div>
          <p class="text-xs text-gray-400 mb-1">Timestamp</p>
          <p class="font-mono text-sm">{{ job.scan.timestamp }}</p>
        </div>
      </div>
      
      {% if job.scan.ports %}
        <div class="overflow-x-auto">
          <table class="w-full text-left text-xs border border-white/10 rounded-lg overflow-hidden">
            <thead class="bg-slate-800/60">
              <tr>
                <th class="p-3 font-medium">Port</th>
                <th class="p-3 font-medium">State</th>
                <th class="p-3 font-medium">Service</th>
                <th class="p-3 font-medium">Product</th>
                <th class="p-3 font-medium">Version</th>
              </tr>
            </thead>
            <tbody>
              {% for p in job.scan.ports %}
              <tr class="border-t border-white/10 {{ 'bg-yellow-900/20' if p.state == 'open' else '' }}">
                <td class="p-3 font-mono">{{ p.port }}/{{ p.proto }}</td>
                <td class="p-3">
                  <span class="px-2 py-1 rounded text-xs {{ 'bg-green-900 text-green-200' if p.state == 'open' else 'bg-red-900 text-red-200' if p.state == 'closed' else 'bg-gray-700 text-gray-300' }}">
                    {{ p.state }}
                  </span>
                </td>
                <td class="p-3">{{ p.service or '-' }}</td>
                <td class="p-3">{{ p.product or '-' }}</td>
                <td class="p-3">{{ p.version or '-' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
      
      {% if job.scan.inferences %}
        <div class="mt-3 p-3 bg-indigo-900/30 border border-indigo-400/20 rounded-lg">
          <h4 class="text-xs font-semibold text-indigo-300 mb-2">AI Inferences</h4>
          {% if job.scan.inferences.possible_domain_controller %}
            <div class="flex items-center gap-2 text-xs">
              <svg class="h-4 w-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
              </svg>
              <span class="text-indigo-200">Possible Domain Controller detected</span>
            </div>
          {% endif %}
          {% if job.scan.inferences.kerberos_present %}
            <div class="flex items-center gap-2 text-xs mt-1">
              <svg class="h-4 w-4 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
              </svg>
              <span class="text-red-200">Kerberos service - potential Zerologon vulnerability</span>
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% endif %}

  <!-- PoC Information -->
  {% if job and job.poc %}
    <div class="bg-slate-800/30 rounded-lg p-4 mb-6">
      <h3 class="text-sm font-semibold mb-3">PoC Research Results</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <p class="text-xs text-gray-400 mb-1">Target CVE</p>
          <p class="font-mono text-sm">{{ job.poc.cve }}</p>
        </div>
        <div>
          <p class="text-xs text-gray-400 mb-1">Sources Found</p>
          <p class="font-mono text-sm">{{ job.poc.sources|length if job.poc.sources else 0 }}</p>
        </div>
      </div>
      
      {% if job.poc.selected %}
        <div class="p-3 bg-indigo-900/20 border border-indigo-400/20 rounded-lg">
          <h4 class="text-xs font-semibold text-indigo-300 mb-2">Selected PoC</h4>
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium">{{ job.poc.selected.name }}</p>
              <p class="text-xs text-gray-400">Score: {{ job.poc.selected.score }} | {{ job.poc.selected.type|title }}</p>
            </div>
            {% if job.poc.selected.url %}
              <a href="{{ job.poc.selected.url }}" target="_blank" class="text-indigo-400 hover:text-indigo-300 text-xs">View Source →</a>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>
  {% endif %}

  <!-- Live Exploit Log -->
  {% if job and job.exploit_log_tail and job.status != 'completed' %}
    <div class="bg-slate-800/30 rounded-lg p-4 mb-6">
      <h3 class="text-sm font-semibold mb-3">Exploit Execution Log</h3>
      <pre class="bg-slate-900/60 border border-white/10 p-3 rounded text-gray-300 text-xs overflow-auto max-h-40 font-mono">{{ job.exploit_log_tail }}</pre>
    </div>
  {% endif %}

  <div class="flex items-center justify-between">
    <a href="/" class="text-indigo-400 hover:text-indigo-300 text-sm">← Back to Home</a>
    <button onclick="location.reload()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-sm transition">
      Refresh Status
    </button>
  </div>
</section>

<script>
// Auto-refresh for running jobs
{% if job and job.status == 'running' %}
  let refreshInterval = setInterval(() => {
    fetch(`/api/job/{{ job_id }}`)
      .then(response => response.json())
      .then(data => {
        // Update progress bar
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        if (progressBar && data.progress !== undefined) {
          progressBar.style.width = data.progress + '%';
          progressPercent.textContent = data.progress + '%';
        }
        
        // Update status indicator
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        if (data.status === 'completed') {
          statusIndicator.className = 'h-3 w-3 rounded-full bg-green-400';
          statusText.textContent = 'Completed';
          clearInterval(refreshInterval);
          // Reload page to show results
          setTimeout(() => location.reload(), 1000);
        } else if (data.status === 'failed') {
          statusIndicator.className = 'h-3 w-3 rounded-full bg-red-400';
          statusText.textContent = 'Failed';
          clearInterval(refreshInterval);
          setTimeout(() => location.reload(), 1000);
        } else {
          statusText.textContent = data.phase ? data.phase.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Running';
        }
      })
      .catch(error => {
        console.error('Error fetching job status:', error);
      });
  }, 3000); // Refresh every 3 seconds
{% endif %}
</script>

{% endblock %}
