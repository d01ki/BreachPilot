# Exploit Failure Analysis Guide

## 🎯 概要

エクスプロイトが失敗した場合、BreachPilotは自動的に詳細な分析を行い、次のアクションを提案します。
もう「失敗して終わり」ではありません。

---

## 📊 失敗分析の例

### ケース1: パッチ済みのDC（あなたの状況）

**実行結果:**
```
[*] Attempt 50/256...
[*] Attempt 100/256...
[*] Attempt 150/256...
[*] Attempt 200/256...
[*] Attempt 250/256...

======================================================================
[-] Attack failed after maximum attempts
======================================================================

[+] Domain Controller appears patched against Zerologon
[+] No vulnerability detected
[+] System is secure from CVE-2020-1472

[*] Analysis:
    - Completed 256 authentication attempts
    - All attempts rejected by Domain Controller
    - Netlogon secure channel protection is functioning
    - DC is likely patched with KB4565457
```

**自動失敗分析レポート:**
```
================================================================================
EXPLOIT FAILURE ANALYSIS REPORT
================================================================================

[EXECUTIVE SUMMARY]
Target: 192.168.253.30
CVE: CVE-2020-1472
Status: EXPLOIT FAILED
Confidence: 95%

[FAILURE CATEGORIES]
  - Target Patched (INFO)

[ROOT CAUSE ANALYSIS]
  1. Target system has security updates installed (KB4565457)
  2. Netlogon secure channel protection is active
  3. High number of attempts suggests target is likely patched

[RECOMMENDATIONS]

  [INFO] System Status: System appears to be patched - This is GOOD
    • Verify patch status: wmic qfe list | findstr KB4565457
    • Document this finding for compliance
    • Consider testing other CVEs
    • Move to next assessment phase

  [MEDIUM] Alternative Approaches: Try alternative exploitation methods
    • Search for other vulnerabilities affecting this target
    • Attempt different CVEs (e.g., PrintNightmare, PetitPotam)
    • Use different exploitation parameters
    • Consult with CrewAI agents for alternative strategies

  [LOW] Verification: Manual verification recommended
    • Review full execution output for additional clues
    • Check Windows Event Logs on target (Event ID 5827, 5828)
    • Verify target system version and patch level
    • Consider alternative scanning tools for verification

[ALTERNATIVE EXPLOITATION METHODS]

  • Different CVE (Difficulty: Easy, Success: Medium)
    Test for other vulnerabilities (PrintNightmare, PetitPotam, etc.)

  • Social Engineering (Difficulty: Hard, Success: Variable)
    Attempt credential gathering through non-technical means

  • Post-Auth Exploitation (Difficulty: Medium, Success: Medium)
    Obtain valid credentials first, then exploit authenticated vulnerabilities

  • Comprehensive Scan (Difficulty: Easy, Success: High)
    Run full vulnerability scan to identify all weaknesses

  • Credential Attacks (Difficulty: Medium, Success: Medium)
    Password spraying, credential stuffing, or Kerberoasting

[NEXT STEPS]
  1. Review the recommendations above in priority order
  2. Address any network or configuration issues
  3. If target is patched, document and move to next phase
  4. Consider alternative exploitation methods
  5. Consult with security team for additional strategies

================================================================================
```

**Artifacts表示:**
```
✓ Target appears to be patched against Zerologon
✓ No vulnerability detected - System is secure
💡 System appears to be patched - This is GOOD
💡 Try alternative exploitation methods
💡 Manual verification recommended
```

---

### ケース2: ネットワーク接続の問題

**実行結果:**
```
[!] Pre-flight check failed

Connectivity Issues:
  - Host 192.168.253.30 is not reachable via ICMP
  - SMB port 445 is not accessible on 192.168.253.30
```

**自動失敗分析レポート:**
```
================================================================================
EXPLOIT FAILURE ANALYSIS REPORT
================================================================================

[EXECUTIVE SUMMARY]
Target: 192.168.253.30
CVE: CVE-2020-1472
Status: EXPLOIT FAILED
Confidence: 90%

[FAILURE CATEGORIES]
  - Network Connectivity (HIGH)

[ROOT CAUSE ANALYSIS]
  1. Network connectivity issue between scanner and target
  2. Firewall may be blocking required ports (TCP 445, 135)
  3. Low number of attempts suggests connection or configuration issue

[RECOMMENDATIONS]

  [HIGH] Network: Verify network connectivity
    • ping 192.168.253.30
    • nmap -p 445,135 192.168.253.30
    • Check firewall rules on both source and target
    • Verify you're on the same network segment

  [MEDIUM] Alternative Approaches: Try alternative exploitation methods
    • Search for other vulnerabilities affecting this target
    • Attempt different CVEs (e.g., PrintNightmare, PetitPotam)
    • Use different exploitation parameters
    • Consult with CrewAI agents for alternative strategies

[ALTERNATIVE EXPLOITATION METHODS]

  • VPN Connection (Difficulty: Easy, Success: High)
    Establish VPN connection to target network

  • Proxy/Relay (Difficulty: Medium, Success: Medium)
    Use intermediate host to reach target

  • Comprehensive Scan (Difficulty: Easy, Success: High)
    Run full vulnerability scan to identify all weaknesses

[NEXT STEPS]
  1. Review the recommendations above in priority order
  2. Address any network or configuration issues
  3. If target is patched, document and move to next phase
  4. Consider alternative exploitation methods
  5. Consult with security team for additional strategies

================================================================================
```

---

### ケース3: 設定の問題

**実行結果:**
```
[*] Connecting to Netlogon service...
[-] Unexpected error code: 0xc000000d
[-] This may indicate a patched system or configuration issue
```

**自動失敗分析レポート:**
```
================================================================================
EXPLOIT FAILURE ANALYSIS REPORT
================================================================================

[EXECUTIVE SUMMARY]
Target: 192.168.253.30
CVE: CVE-2020-1472
Status: EXPLOIT FAILED
Confidence: 75%

[FAILURE CATEGORIES]
  - Configuration Issue (MEDIUM)

[ROOT CAUSE ANALYSIS]
  1. DC name may be incorrect (use NetBIOS name, not FQDN)
  2. Target may not be a Domain Controller
  3. Unable to determine specific root cause from output

[RECOMMENDATIONS]

  [MEDIUM] Configuration: Verify target configuration
    • Confirm DC name is correct: DC2019
    • Use NetBIOS name, not FQDN (e.g., 'DC01' not 'dc01.domain.com')
    • Verify target is actually a Domain Controller
    • Check if Netlogon service is running on target

  [MEDIUM] Alternative Approaches: Try alternative exploitation methods
    • Search for other vulnerabilities affecting this target
    • Attempt different CVEs (e.g., PrintNightmare, PetitPotam)
    • Use different exploitation parameters
    • Consult with CrewAI agents for alternative strategies

[ALTERNATIVE EXPLOITATION METHODS]

  • Target Enumeration (Difficulty: Easy, Success: High)
    Perform comprehensive enumeration to identify correct parameters

  • Alternative DCs (Difficulty: Easy, Success: High)
    If multiple DCs exist, try targeting different ones

  • Comprehensive Scan (Difficulty: Easy, Success: High)
    Run full vulnerability scan to identify all weaknesses

[!] MANUAL REVIEW REQUIRED
    The automated analysis has low confidence.
    Please review the full execution output manually.

================================================================================
```

---

## 🔍 分析の仕組み

### 1. 失敗カテゴリの識別

失敗分析システムは、以下のカテゴリを自動的に識別します：

**Network Connectivity (HIGH)**
- Patterns: "no route to host", "connection refused", "timeout"
- 原因: ネットワーク設定、ファイアウォール
- 対策: 接続テスト、ファイアウォール確認

**Authentication (MEDIUM)**
- Patterns: "access denied", "authentication failed", "permission denied"
- 原因: 認証情報の問題
- 対策: 資格情報の確認、権限の検証

**Target Patched (INFO)**
- Patterns: "attack failed", "appears patched", "no vulnerability"
- 原因: システムにパッチが適用済み
- 対策: 他のCVEを試す、コンプライアンス文書化

**Configuration Issue (MEDIUM)**
- Patterns: "unexpected error", "incorrect dc name", "service unavailable"
- 原因: 設定ミス、サービス停止
- 対策: 設定確認、サービス状態確認

### 2. ルートコーズ分析

自動的に以下を分析します：

1. **エラー出力のパターンマッチング**
   - 既知のエラーパターンと照合
   - 複数のカテゴリに該当する可能性

2. **実行コンテキストの分析**
   - 試行回数（少ない = 接続問題、多い = パッチ済み）
   - リターンコード（0=成功, 1=失敗, 2=エラー）
   - 実行時間（短い = 即座のエラー、長い = タイムアウト）

3. **統計的推論**
   - 試行回数 > 200 → 高確率でパッチ済み
   - 試行回数 < 10 → 接続または設定の問題

### 3. 推奨事項の生成

優先度付きの推奨事項を自動生成：

**HIGH (緊急)**
- ネットワーク接続の問題
- クリティカルな設定ミス

**MEDIUM (重要)**
- 代替手法の試行
- 設定の検証

**LOW (推奨)**
- 手動検証
- ドキュメント化

**INFO (情報)**
- パッチ適用済み（これは良いこと！）

### 4. 代替アプローチの提案

失敗の種類に応じて、以下のような代替手法を提案：

#### ネットワーク問題の場合
- VPN接続の確立
- プロキシ/リレーの使用
- ネットワーク設定の変更

#### パッチ済みの場合
- 他のCVEのテスト
- ソーシャルエンジニアリング
- 認証後の攻撃
- 資格情報攻撃（パスワードスプレー等）

#### 設定問題の場合
- ターゲットの列挙
- 代替DCのターゲット化
- 包括的スキャン

---

## 💡 使用方法

### ステップ1: エクスプロイト実行

通常通りエクスプロイトを実行します。

### ステップ2: 結果の確認

失敗した場合、自動的に分析レポートが生成されます。

### ステップ3: 推奨事項の実施

**HIGH**優先度から順に対処：

1. ネットワーク接続を確認
   ```bash
   ping 192.168.253.30
   nmap -p 445,135 192.168.253.30
   ```

2. 設定を検証
   - DC名が正しいか確認
   - NetBIOS名を使用（FQDNではない）

3. 代替手法を試行
   - 他のCVEを検索
   - 包括的スキャンを実行

### ステップ4: 次のアクション

分析レポートの「NEXT STEPS」セクションに従います。

---

## 📈 信頼度スコア

各分析には信頼度スコアが付与されます：

- **90-100%**: 非常に高い信頼度
  - 明確なエラーパターン検出
  - 複数の証拠が一致
  - 推奨事項に従うべき

- **70-89%**: 高い信頼度
  - エラーパターン検出
  - 実行コンテキストと一致
  - 推奨事項を試行する価値あり

- **50-69%**: 中程度の信頼度
  - 一部のパターンのみ検出
  - 手動レビュー推奨

- **<50%**: 低い信頼度
  - パターン検出失敗
  - **手動レビュー必須**
  - セキュリティチームに相談

---

## 🎓 ベストプラクティス

### 1. 段階的アプローチ

```
1. 自動分析レポートを読む
   ↓
2. HIGH優先度の推奨事項を実施
   ↓
3. 問題が解決しない場合、MEDIUM優先度を試す
   ↓
4. それでも解決しない場合、代替アプローチを検討
   ↓
5. 必要に応じてセキュリティチームに相談
```

### 2. ドキュメント化

各失敗について記録：
- 失敗の原因
- 試した対策
- 最終的な結論

### 3. 学習と改善

失敗から学ぶ：
- よくある失敗パターンを認識
- 効果的な対策を記憶
- チーム内で知識共有

### 4. パッチ済みは成功

パッチ適用済みの検出は失敗ではなく、重要な発見です：
- セキュリティ態勢が良好
- コンプライアンス文書に記載
- 他の評価項目に移行

---

## 🔧 トラブルシューティング

### Q: 分析レポートが表示されない

**A:** 以下を確認：
```bash
# ExploitAnalyzerがインポートされているか
python3 -c "from backend.exploiter.exploit_analyzer import ExploitAnalyzer; print('OK')"

# 依存関係の確認
pip install -r requirements.txt
```

### Q: 信頼度スコアが低い

**A:** 手動レビューが必要です：
1. 完全な実行出力を確認
2. ターゲットシステムのログを確認
3. セキュリティチームに相談

### Q: 推奨事項を試したが解決しない

**A:** 次の段階へ：
1. 別のCVEを試す
2. 包括的スキャンを実行
3. 専門家に相談

---

## 📚 関連ドキュメント

- [NETWORK_TROUBLESHOOTING.md](NETWORK_TROUBLESHOOTING.md) - ネットワーク問題の詳細
- [EXPLOIT_EXECUTION_GUIDE.md](EXPLOIT_EXECUTION_GUIDE.md) - エクスプロイト実行ガイド
- [ZEROLOGON_FIX_SUMMARY.md](ZEROLOGON_FIX_SUMMARY.md) - Zerologon修正の詳細

---

## 🎯 まとめ

**Before (修正前):**
```
EXPLOIT FAILED ❌
（終了）
```

**After (修正後):**
```
EXPLOIT FAILED ❌

✓ 詳細な失敗分析レポート
✓ ルートコーズ特定
✓ 優先度付き推奨事項
✓ 代替アプローチの提案
✓ 次のステップガイダンス
✓ もう「失敗して終わり」ではない！
```

---

**ドキュメントバージョン:** 1.0  
**最終更新:** 2025-01-02  
**作成者:** BreachPilot Security Team
